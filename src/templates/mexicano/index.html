{% extends "mexicano/base.html" %}
{% block title %}Padel Mexicano ‚Äî –¢—É—Ä–Ω–∏—Ä—ã{% endblock %}
{% block nav_mx %}active-mexicano{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/mexicano.css">
{% endblock %}

{% block content %}
<div class="hero animate">
    <div class="hero-eyebrow">üåÆ –°–∏—Å—Ç–µ–º–∞ –º–µ–∫—Å–∏–∫–∞–Ω–æ</div>
    <h1>PADEL<br>MEXICANO</h1>
    <p>–¢—É—Ä–Ω–∏—Ä—ã, –≥–¥–µ –ø–∞—Ä—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É ‚Äî —Ä–∞–≤–Ω—ã–µ –∏–≥—Ä–∞—é—Ç –ø—Ä–æ—Ç–∏–≤ —Ä–∞–≤–Ω—ã—Ö –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞.</p>
</div>

<div class="card animate" style="animation-delay: 0.3s; margin-top: 2rem">
    <div class="section-title">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ú–µ–∫—Å–∏–∫–∞–Ω–æ</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem">
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üìä</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ä–∞—É–Ω–¥–æ–º –∏–≥—Ä–æ–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –æ—á–∫–∞–º: 1-–π –∏ 2-–π –∏–≥—Ä–∞—é—Ç –≤–º–µ—Å—Ç–µ –ø—Ä–æ—Ç–∏–≤ 3-–≥–æ –∏ 4-–≥–æ.</p>
        </div>
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">‚öñÔ∏è</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–ú–∞—Ç—á–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—Å—ë –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ ‚Äî —Å–∏–ª—å–Ω—ã–µ –∏–≥—Ä–∞—é—Ç –ø—Ä–æ—Ç–∏–≤ —Å–∏–ª—å–Ω—ã—Ö, —Å–ª–∞–±—ã–µ –ø—Ä–æ—Ç–∏–≤ —Å–ª–∞–±—ã—Ö.</p>
        </div>
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üèÅ</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–ó–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Ä–∞—É–Ω–¥–æ–≤</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ê–º–µ—Ä–∏–∫–∞–Ω–æ, –≤—ã –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–¥–∞—ë—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—É–Ω–¥–æ–≤. –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ.</p>
        </div>
    </div>
</div>

<div class="create-section">
    <div class="card animate" style="animation-delay: 0.1s">
        <div class="section-title">–ù–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä</div>
        <form action="/mexicano/create" method="post">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="text" name="name" placeholder="–ú–µ–∫—Å–∏–∫–∞–Ω—Å–∫–∏–π –∫—É–±–æ–∫" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ—Ä—Ç–æ–≤</label>
                    <input type="number" name="courts" value="2" min="1" max="8" required>
                </div>
            </div>
            <div class="form-group">
                <label>–†–∞—É–Ω–¥–æ–≤</label>
                <input type="number" name="num_rounds" value="6" min="1" max="20" required>
            </div>
            <div class="form-group">
                <label>–ò–≥—Ä–æ–∫–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                <textarea name="player_names" rows="8" placeholder="–ê–ª–µ–∫—Å–µ–π&#10;–ú–∞—Ä–∏—è&#10;–î–º–∏—Ç—Ä–∏–π&#10;–ê–Ω–Ω–∞&#10;–°–µ—Ä–≥–µ–π&#10;–ï–ª–µ–Ω–∞&#10;–ü–∞–≤–µ–ª&#10;–û–ª—å–≥–∞" required></textarea>
                <div style="font-size:0.75rem; color: var(--muted); margin-top:0.4rem">–ú–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞, –∫—Ä–∞—Ç–Ω–æ 4 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</div>
            </div>
            <button type="submit" class="btn btn-submit" style="width:100%">
                üåÆ –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
            </button>
        </form>
    </div>

    <div class="card animate" style="animation-delay: 0.2s">
        <div class="section-title">–¢—É—Ä–Ω–∏—Ä—ã</div>
        <div class="cache-hint">
            <span>üì±</span> –ü–æ–∫–∞–∑–∞–Ω—ã 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ –ú–µ–∫—Å–∏–∫–∞–Ω–æ, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–æ—Å–µ—â–∞–ª–∏ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        </div>
        <div id="tournaments-list">
            <div class="empty-state" id="empty-state">
                <div class="empty-icon">üåÆ</div>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç—É—Ä–Ω–∏—Ä –ú–µ–∫—Å–∏–∫–∞–Ω–æ</p>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast" role="alert" aria-live="assertive">
    <div class="toast-icon">üóëÔ∏è</div>
    <div class="toast-body">
        <div class="toast-title">–¢—É—Ä–Ω–∏—Ä —É–¥–∞–ª—ë–Ω</div>
        <div class="toast-text" id="toast-text"></div>
    </div>
    <button class="toast-close" onclick="hideToast()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
</div>

<script>
(function() {
    const CACHE_KEY = 'padel_mexicano_tournaments';
    const listEl   = document.getElementById('tournaments-list');
    const emptyEl  = document.getElementById('empty-state');
    const toastEl  = document.getElementById('toast');
    const toastTxt = document.getElementById('toast-text');
    let toastTimer = null;

    window.hideToast = function() {
        toastEl.classList.remove('visible');
        clearTimeout(toastTimer);
    };

    function showToast() {
        toastTxt.textContent = '–¢—É—Ä–Ω–∏—Ä –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.';
        toastEl.classList.add('visible');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(hideToast, 5000);
    }

    function getCached() {
        try { return JSON.parse(localStorage.getItem(CACHE_KEY) || '{}'); } catch(e) { return {}; }
    }
    function setCached(obj) {
        try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch(e) {}
    }

    window.navigateToTournament = async function(id, itemEl) {
        itemEl.classList.add('loading');
        try {
            const res = await fetch(`/mexicano/${id}`, { method: 'HEAD' });
            if (res.ok) { window.location.href = `/mexicano/${id}`; return; }
            if (res.status === 404) {
                const cached = getCached();
                delete cached[id];
                setCached(cached);
                itemEl.style.transition = 'opacity 0.3s, transform 0.3s';
                itemEl.style.opacity = '0';
                itemEl.style.transform = 'translateX(14px)';
                setTimeout(() => {
                    itemEl.remove();
                    if (!listEl.querySelector('.t-item')) emptyEl.style.display = 'block';
                }, 300);
                showToast();
                return;
            }
        } catch(e) {}
        window.location.href = `/mexicano/${id}`;
    };

    window.removeFromCache = function(id, e) {
        e.stopPropagation();
        const cached = getCached();
        delete cached[id];
        setCached(cached);
        render();
    };

    function statusLabel(status) {
        if (status === 'active')   return { text: '–ê–∫—Ç–∏–≤–µ–Ω',  cls: 'badge-active-js' };
        if (status === 'finished') return { text: '–ó–∞–≤–µ—Ä—à—ë–Ω', cls: 'badge-finished-js' };
        return { text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞', cls: 'badge-setup-js' };
    }

    function timeAgo(ts) {
        const diff = Date.now() - ts;
        const mins = Math.floor(diff / 60000);
        if (mins < 1)  return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (mins < 60) return `${mins} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24)  return `${hrs} —á. –Ω–∞–∑–∞–¥`;
        return `${Math.floor(hrs / 24)} –¥. –Ω–∞–∑–∞–¥`;
    }

    function escHtml(str) {
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function render() {
        const cached = getCached();
        const items  = Object.values(cached).sort((a, b) => b.visitedAt - a.visitedAt);
        listEl.querySelectorAll('.t-item').forEach(el => el.remove());
        if (items.length === 0) { emptyEl.style.display = 'block'; return; }
        emptyEl.style.display = 'none';
        items.forEach(t => {
            const sl = statusLabel(t.status);
            const nameEsc = escHtml(t.name);
            const div = document.createElement('div');
            div.className  = 't-item';
            div.dataset.id = t.id;
            div.innerHTML  = `
                <div class="t-icon">üåÆ</div>
                <div class="t-info" onclick="navigateToTournament('${t.id}', this.closest('.t-item'))">
                    <div class="t-name">${nameEsc}</div>
                    <div class="t-meta">${t.playerCount} –∏–≥—Ä–æ–∫–æ–≤ ¬∑ ${t.courts} –∫–æ—Ä—Ç(–∞) ¬∑ –†–∞—É–Ω–¥ ${t.currentRound + 1}/${t.totalRounds} ¬∑ ${timeAgo(t.visitedAt)}</div>
                </div>
                <span class="badge ${sl.cls}">${sl.text}</span>
                <button class="t-remove" title="–£–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞" onclick="removeFromCache('${t.id}', event)">‚úï</button>
            `;
            listEl.appendChild(div);
        });
    }
    render();
})();
</script>
{% endblock %}