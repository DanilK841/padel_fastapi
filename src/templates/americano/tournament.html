{% extends "americano/base.html" %}
{% block title %}{{ tournament.name }} ‚Äî Padel Americano{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/americano.css">
{% endblock %}

{% block content %}

<!-- Share URL bar -->
<div class="share-bar animate">
    <div class="share-inner">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent); flex-shrink:0"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        <span class="share-url" id="tournamentUrl"></span>
        <button class="copy-btn" onclick="copyUrl()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
            <svg id="copyIcon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            <span id="copyLabel">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
        </button>
    </div>
    <div class="share-hint">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º ‚Äî –æ–Ω–∏ —Å–º–æ–≥—É—Ç —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç—É—Ä–Ω–∏—Ä–æ–º –∏ –≤–≤–æ–¥–∏—Ç—å —Å—á—ë—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</div>   
</div>

<script>
document.getElementById('tournamentUrl').textContent = window.location.href;

function copyUrl() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        const btn = document.querySelector('.copy-btn');
        const label = document.getElementById('copyLabel');
        const icon = document.getElementById('copyIcon');
        btn.classList.add('copied');
        label.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        icon.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
        setTimeout(() => {
            btn.classList.remove('copied');
            label.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
            icon.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>';
        }, 2000);
    });
}
</script>

<div class="tournament-header animate">
    <div class="t-title-group">
        <div style="font-size:0.8rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:0.5rem">
            <a href="/americano" style="color:var(--muted); text-decoration:none">‚Üê –¢—É—Ä–Ω–∏—Ä—ã</a>
        </div>
        <h1>{{ tournament.name }}</h1>
        <div class="header-actions">
            <span class="badge badge-{{ tournament.status }}">
                {% if tournament.status == 'active' %}–ê–∫—Ç–∏–≤–µ–Ω
                {% elif tournament.status == 'finished' %}–ó–∞–≤–µ—Ä—à—ë–Ω
                {% else %}–ù–∞—Å—Ç—Ä–æ–π–∫–∞{% endif %}
            </span>
            <form action="/americano/tournament/{{ tournament.id }}/delete" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä?')">
                <button type="submit" class="btn btn-danger" style="padding: 0.35rem 0.9rem; font-size:0.8rem">‚úï –£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>
    <div class="grid-3 animate" style="animation-delay:0.1s">
        <div class="stat-box">
            <div class="stat-value">{{ tournament.players | length }}</div>
            <div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ tournament.courts }}</div>
            <div class="stat-label">–ö–æ—Ä—Ç–æ–≤</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ tournament.current_round + 1 }}/{{ total_rounds }}</div>
            <div class="stat-label">–†–∞—É–Ω–¥</div>
        </div>
    </div>
</div>


<!-- Round progress -->
<div class="round-indicator animate" style="animation-delay:0.15s">
    {% for i in range(total_rounds) %}
    <div class="round-dot {% if i < tournament.current_round %}done{% elif i == tournament.current_round %}current{% endif %}">{{ i+1 }}</div>
    {% endfor %}
</div>

{% if tournament.status == 'finished' %}
<div class="finished-banner animate">
    <div style="font-size:2.5rem; margin-bottom:0.5rem">üèÜ</div>
    <h2>–¢–£–†–ù–ò–† –ó–ê–í–ï–†–®–Å–ù!</h2>
    <p style="color:var(--muted)">–í—Å–µ —Ä–∞—É–Ω–¥—ã —Å—ã–≥—Ä–∞–Ω—ã. –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∏–∂–µ.</p>
</div>
{% endif %}

<div class="grid-2">
    <!-- Current matches -->
    <div class="animate" style="animation-delay:0.2s">
        {% if tournament.status != 'finished' %}
        <div class="section-title">–¢–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥ ‚Äî {{ tournament.current_round + 1 }}</div>
        <div class="court-grid">
            {% for match in current_matches %}
            <div class="court-card {% if match.completed %}completed{% endif %}">
                <div class="court-header">
                    <span class="court-name">–ö–æ—Ä—Ç {{ match.court }}</span>
                    {% if match.completed %}
                    <span style="font-size:0.75rem; color:#7dffb3; font-weight:600">‚úì –ó–∞–≤–µ—Ä—à—ë–Ω</span>
                    {% else %}
                    <span style="font-size:0.75rem; color:var(--muted)">–ò–¥—ë—Ç –∏–≥—Ä–∞</span>
                    {% endif %}
                </div>
                <div class="court-body">
                    <div class="vs-layout">
                        <div class="team">
                            <div class="team-label">–ö–æ–º–∞–Ω–¥–∞ 1</div>
                            {% for pid in match.team1 %}
                            <div class="player-name">
                            {{ tournament.players[pid].name }}
                            {% if not match.completed %}
                            <button type="button" class="edit-player-btn"
                                    data-match-id="{{ match.id }}"
                                    data-position="team1-{{ loop.index0 }}"
                                    data-pid="{{ pid }}"
                                    title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞">‚úè</button>
                            {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="team">
                            <div class="team-label">–ö–æ–º–∞–Ω–¥–∞ 2</div>
                            {% for pid in match.team2 %}
                            <div class="player-name">
                                {{ tournament.players[pid].name }}
                                {% if not match.completed %}
                                <button type="button" class="edit-player-btn"
                                        data-match-id="{{ match.id }}"
                                        data-position="team2-{{ loop.index0 }}"
                                        data-pid="{{ pid }}"
                                        title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞">‚úè</button>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    {% if match.completed %}
                    <!-- Score display with inline edit -->
                    <div id="score-display-{{ match.id }}">
                        <div class="score-display">
                            <div class="score-val">{{ match.score1 }}</div>
                            <div class="score-colon">:</div>
                            <div class="score-val">{{ match.score2 }}</div>
                        </div>
                        <button type="button" class="edit-score-toggle" onclick="toggleEdit('{{ match.id }}')">
                            ‚úè –ò–∑–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç
                        </button>
                    </div>
                    <div class="edit-score-form" id="edit-form-{{ match.id }}">
                        <form method="post" action="/americano/tournament/{{ tournament.id }}/edit-score">
                            <input type="hidden" name="match_id" value="{{ match.id }}">
                            <div class="score-inputs">
                                <input type="number" name="score1" class="score-input" value="{{ match.score1 }}" min="0" max="99" required>
                                <div class="vs-divider" style="font-size:1.4rem">:</div>
                                <input type="number" name="score2" class="score-input" value="{{ match.score2 }}" min="0" max="99" required>
                            </div>
                            <div class="edit-form-actions">
                                <button type="submit" class="btn btn-primary btn-xs">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" class="btn btn-secondary btn-xs" onclick="toggleEdit('{{ match.id }}')">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <form class="score-form" method="post" action="/americano/tournament/{{ tournament.id }}/score">
                        <input type="hidden" name="match_id" value="{{ match.id }}">
                        <div class="score-inputs">
                            <input type="number" name="score1" class="score-input" placeholder="0" min="0" max="99" required>
                            <div class="vs-divider" style="font-size:1.4rem">:</div>
                            <input type="number" name="score2" class="score-input" placeholder="0" min="0" max="99" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%; font-size:0.85rem">–ó–∞–ø–∏—Å–∞—Ç—å —Å—á—ë—Ç</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Next round button -->
        {% set all_done = current_matches | selectattr('completed') | list | length == current_matches | length %}
        {% if current_matches and all_done %}
        <div class="grid-2">
            <form method="post" action="/americano/tournament/{{ tournament.id }}/finish" style="margin-top:1rem">
                <button type="submit" class="btn btn-primary">
                    üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä
                </button>
            </form>
            {% if tournament.current_round + 1 < total_rounds %}
            <form method="post" action="/americano/tournament/{{ tournament.id }}/next-round" style="margin-top:1rem">
                <button type="submit" class="btn btn-primary">
                    ‚û° –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
                </button>
            </form>
            {% endif %}
        </div>    
        {% endif %}
        {% endif %}
    </div>

    <!-- Standings -->
    <div class="card animate" style="animation-delay:0.25s">
        <div class="section-title">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</div>
        <table class="standings-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ò–≥—Ä–æ–∫</th>
                    <th>–û—á–∫–∏</th>
                    <th>–ò–≥—Ä</th>
                    <th>W</th>
                    <th>L</th>
                </tr>
            </thead>
            <tbody>
                {% for s in standings %}
                <tr>
                    <td class="rank-cell rank-{{ s.rank }}">{{ s.rank }}</td>
                    <td class="player-cell">
                        {% if s.rank == 1 %}ü•á {% elif s.rank == 2 %}ü•à {% elif s.rank == 3 %}ü•â {% endif %}
                        {{ s.name }}
                    </td>
                    <td class="pts-cell">{{ s.points }}</td>
                    <td style="color:var(--muted)">{{ s.games_played }}</td>
                    <td style="color:#7dffb3; font-weight:600">{{ s.games_won }}</td>
                    <td style="color:#f57045; font-weight:600">{{ s.games_lost }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- All rounds summary -->
{% if tournament.current_round > 0 or (current_matches and current_matches[0].completed) %}
<div class="card animate" style="animation-delay:0.3s; margin-top:1.5rem">
    <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤</div>
    {% for round_matches in tournament.rounds %}
    {% set completed_in_round = round_matches | selectattr('completed') | list %}
    {% if completed_in_round %}
    <div style="margin-bottom:1.25rem">
        <div style="font-family:'Bebas Neue', sans-serif; font-size:1.1rem; color:var(--muted); margin-bottom:0.6rem; letter-spacing:0.05em">–†–∞—É–Ω–¥ {{ loop.index }}</div>
        <div style="display:flex; flex-wrap:wrap; gap:0.6rem">
            {% for match in completed_in_round %}
            <div class="history-match">
                <div class="history-match-row">
                    <span style="color:var(--muted)">–ö{{ match.court }}</span>
                    <span style="font-weight:600">
                        {% for pid in match.team1 %}{{ tournament.players[pid].name }}{% if not loop.last %} / {% endif %}{% endfor %}
                    </span>
                    <span style="font-family:'Bebas Neue'; font-size:1rem; color:var(--accent)">{{ match.score1 }}:{{ match.score2 }}</span>
                    <span style="font-weight:600">
                        {% for pid in match.team2 %}{{ tournament.players[pid].name }}{% if not loop.last %} / {% endif %}{% endfor %}
                    </span>
                    <button type="button"
                        onclick="toggleHistoryEdit('{{ match.id }}')"
                        style="rotate:135deg; background:none; border:none; color:var(--muted); cursor:pointer; font-size:1.75rem; padding:0 0.25rem; line-height:1; transition:color 0.15s;"
                        title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—á—ë—Ç"
                        onmouseover="this.style.color='var(--accent)'"
                        onmouseout="this.style.color='var(--muted)'">‚úè</button>
                </div>
                <div class="history-edit-form" id="history-edit-{{ match.id }}">
                    <form method="post" action="/americano/tournament/{{ tournament.id }}/edit-score">
                        <input type="hidden" name="match_id" value="{{ match.id }}">
                        <div class="history-score-inputs">
                            <input type="number" name="score1" class="score-input history-score-input" value="{{ match.score1 }}" min="0" max="99" required>
                            <span style="font-family:'Bebas Neue'; font-size:1.2rem; color:var(--muted); padding: 0 0.2rem">:</span>
                            <input type="number" name="score2" class="score-input history-score-input" value="{{ match.score2 }}" min="0" max="99" required>
                            <button type="submit" class="btn btn-primary btn-xs" style="margin-left:0.4rem">‚úì</button>
                            <button type="button" class="btn btn-secondary btn-xs" onclick="toggleHistoryEdit('{{ match.id }}')">‚úï</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- === PLAYER SWAP MODAL === -->
<div id="swap-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSwapModal()">√ó</span>
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∑–∞–º–µ–Ω—ã</h3>
        <div id="modal-players" class="modal-players"></div>
    </div>
</div>
<script>
const tournamentId = "{{ tournament.id }}";
const allPlayers = {{ players_json | tojson }};

let currentMatchId = null;
let currentPosition = null;
let currentOldPid = null;

function openSwapModal(matchId, position, oldPid) {
    currentMatchId = matchId;
    currentPosition = position;
    currentOldPid = oldPid;

    const container = document.getElementById("modal-players");
    container.innerHTML = "";

    Object.values(allPlayers).forEach(player => {
        const div = document.createElement("div");
        div.className = "player-option" + (player.id === oldPid ? " current" : "");
        div.textContent = player.name + (player.id === oldPid ? " (—Ç–µ–∫—É—â–∏–π)" : "");
        div.onclick = () => {
            if (player.id !== oldPid) performSwap(player.id);
        };
        container.appendChild(div);
    });

    document.getElementById("swap-modal").style.display = "flex";
}

function closeSwapModal() {
    document.getElementById("swap-modal").style.display = "none";
}

async function performSwap(newPid) {
    closeSwapModal();

    const fd = new FormData();
    fd.append("match_id", currentMatchId);
    fd.append("position", currentPosition);
    fd.append("new_pid", newPid);

    try {
        const res = await fetch(`/americano/tournament/${tournamentId}/swap-player`, {
            method: "POST",
            body: fd
        });

        if (res.redirected) {
            window.location.href = res.url;
        } else if (res.ok) {
            window.location.reload();
        } else {
            alert("–û—à–∏–±–∫–∞: " + (await res.text()));
        }
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
    }
}

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".edit-player-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            openSwapModal(
                btn.dataset.matchId,
                btn.dataset.position,
                btn.dataset.pid
            );
        });
    });
});
</script>

<script>
function toggleEdit(matchId) {
    const form = document.getElementById('edit-form-' + matchId);
    form.classList.toggle('visible');
}

function toggleHistoryEdit(matchId) {
    const form = document.getElementById('history-edit-' + matchId);
    form.classList.toggle('visible');
}

<!-- Cache this tournament visit in localStorage -->

(function() {
    const CACHE_KEY = 'padel_tournaments';
    const tData = {
        id: {{ tournament.id | tojson }},
        name: {{ tournament.name | tojson }},
        status: {{ tournament.status | tojson }},
        playerCount: {{ tournament.players | length }},
        courts: {{ tournament.courts }},
        currentRound: {{ tournament.current_round }},
        totalRounds: {{ total_rounds }},
        visitedAt: Date.now()
    };

    try {
        let cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
        cached[tData.id] = tData;

        // Keep only the 5 most recently visited tournaments
        const entries = Object.values(cached).sort((a, b) => b.visitedAt - a.visitedAt);
        if (entries.length > 5) {
            cached = {};
            entries.slice(0, 5).forEach(t => { cached[t.id] = t; });
        }

        localStorage.setItem(CACHE_KEY, JSON.stringify(cached));
    } catch(e) {
        console.warn('Failed to cache tournament:', e);
    }
})();
</script>
{% endblock %}