{% extends "americano/base.html" %}
{% block title %}Padel Americano ‚Äî –¢—É—Ä–Ω–∏—Ä—ã{% endblock %}

{% block extra_styles %}
<style>
.hero {
    text-align: center;
    padding: 3rem 0 0;
}
.hero-eyebrow {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
}
.hero h1 {
    font-size: 5rem;
    line-height: 0.95;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--text) 60%, var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.hero p {
    color: var(--muted);
    font-size: 1.05rem;
    max-width: 480px;
    margin: 0 auto 2rem;
    line-height: 1.6;
}
.create-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
}
@media (max-width: 768px) {
    .create-section { grid-template-columns: 1fr; }
    .hero h1 { font-size: 3.5rem; }
}
.t-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
    transition: opacity 0.2s;
}
.t-item:last-child { border-bottom: none; }
.t-item:hover .t-name { color: var(--accent); }
.t-item.loading { opacity: 0.45; pointer-events: none; }
.t-icon {
    width: 44px; height: 44px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}
.t-info { flex: 1; cursor: pointer; }
.t-name {
    font-weight: 600;
    color: var(--text);
    transition: color 0.15s;
    margin-bottom: 0.2rem;
}
.t-meta { font-size: 0.8rem; color: var(--muted); }
.t-remove {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1rem;
    padding: 0.4rem;
    border-radius: 6px;
    transition: all 0.15s;
    flex-shrink: 0;
    line-height: 1;
}
.t-remove:hover { color: var(--danger); background: rgba(245,69,69,0.1); }
.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--muted);
}
.empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
.section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    letter-spacing: 0.04em;
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
}
.cache-hint {
    font-size: 0.72rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-top: -0.9rem;
    margin-bottom: 1.25rem;
    opacity: 0.7;
}
.badge-active-js   { background: rgba(200,245,69,0.15);  color: var(--accent);  border: 1px solid var(--accent); }
.badge-finished-js { background: rgba(69,245,180,0.15);  color: var(--accent2); border: 1px solid var(--accent2); }
.badge-setup-js    { background: rgba(107,114,128,0.2);  color: var(--muted);   border: 1px solid var(--border); }

/* Toast */
.toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(calc(100% + 3rem));
    background: var(--surface);
    border: 1px solid var(--danger);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: flex-start;
    gap: 0.85rem;
    z-index: 999;
    box-shadow: 0 8px 40px rgba(0,0,0,0.55);
    transition: transform 0.38s cubic-bezier(0.34, 1.4, 0.64, 1);
    max-width: 400px;
    width: calc(100% - 3rem);
}
.toast.visible {
    transform: translateX(-50%) translateY(0);
}
.toast-icon { font-size: 1.35rem; flex-shrink: 0; margin-top: 0.05rem; }
.toast-body { flex: 1; min-width: 0; }
.toast-title { font-weight: 700; font-size: 0.88rem; color: var(--danger); margin-bottom: 0.25rem; }
.toast-text  { font-size: 0.8rem; color: var(--muted); line-height: 1.45; word-break: break-word; }
.toast-close {
    background: none; border: none;
    color: var(--muted); cursor: pointer;
    font-size: 1rem; padding: 0.15rem;
    flex-shrink: 0; line-height: 1;
    transition: color 0.15s;
}
.toast-close:hover { color: var(--text); }
</style>
{% endblock %}

{% block content %}
<div class="hero animate">
    <div class="hero-eyebrow">üéæ –°–∏—Å—Ç–µ–º–∞ –∞–º–µ—Ä–∏–∫–∞–Ω–æ</div>
    <h1>PADEL<br>AMERICANO</h1>
    <p>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—É—Ä–Ω–∏—Ä–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ –ø–æ —Å–∏—Å—Ç–µ–º–µ –ê–º–µ—Ä–∏–∫–∞–Ω–æ.</p>
</div>

<div class="card animate" style="animation-delay: 0.3s; margin-top: 2rem">
    <div class="section-title">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ê–º–µ—Ä–∏–∫–∞–Ω–æ</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem">
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üîÑ</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–†–æ—Ç–∞—Ü–∏—è</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—ã –∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∏ –º–µ–Ω—è—é—Ç—Å—è ‚Äî –∫–∞–∂–¥—ã–π –∏–≥—Ä–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏.</p>
        </div>
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üèÖ</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–û—á–∫–∏</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–ò–≥—Ä–æ–∫–∏ –Ω–∞–±–∏—Ä–∞—é—Ç –æ—á–∫–∏ —Ä–∞–≤–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö –≥–µ–π–º–æ–≤. –ì–µ–π–º - –æ–¥–∏–Ω —Ä–æ–∑—ã–≥—Ä—ã—à. –ò—Ç–æ–≥ ‚Äî –ª–∏—á–Ω—ã–π –∑–∞—á—ë—Ç.</p>
        </div>
        <div>
            <div style="font-size: 1.5rem; margin-bottom: 0.5rem">üë•</div>
            <strong style="font-size: 0.9rem; display:block; margin-bottom:0.3rem">–°–æ—Ü–∏–∞–ª—å–Ω–æ</strong>
            <p style="font-size: 0.85rem; color: var(--muted); line-height:1.5">–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∫–ª—É–±–Ω—ã—Ö –¥–Ω–µ–π ‚Äî –∫–∞–∂–¥—ã–π –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—Å—è —Å –∫–∞–∂–¥—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º.</p>
        </div>
    </div>
</div>

<div class="create-section">
    <div class="card animate" style="animation-delay: 0.1s">
        <div class="section-title">–ù–æ–≤—ã–π —Ç—É—Ä–Ω–∏—Ä</div>
        <form action="/americano/tournament/create" method="post">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞</label>
                    <input type="text" name="name" placeholder="–ö—É–±–æ–∫ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –¥–Ω—è" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ—Ä—Ç–æ–≤</label>
                    <input type="number" name="courts" value="2" min="1" max="8" required>
                </div>
                <!--<div class="form-group">
                    <label>–†–∞—É–Ω–¥–æ–≤</label>
                    <input type="number" name="num_rounds" value="6" min="1" max="20" required>
                </div>-->
            </div>
            <div class="form-group">
                <label>–ò–≥—Ä–æ–∫–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
                <textarea name="player_names" rows="8" placeholder="–ê–ª–µ–∫—Å–µ–π&#10;–ú–∞—Ä–∏—è&#10;–î–º–∏—Ç—Ä–∏–π&#10;–ê–Ω–Ω–∞&#10;–°–µ—Ä–≥–µ–π&#10;–ï–ª–µ–Ω–∞&#10;–ü–∞–≤–µ–ª&#10;–û–ª—å–≥–∞" required></textarea>
                <div style="font-size:0.75rem; color: var(--muted); margin-top:0.4rem">–ú–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞, –∫—Ä–∞—Ç–Ω–æ 4 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">
                üèÜ –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
            </button>
        </form>
    </div>

    <div class="card animate" style="animation-delay: 0.2s">
        <div class="section-title">–¢—É—Ä–Ω–∏—Ä—ã</div>
        <div class="cache-hint">
            <span>üì±</span> –ü–æ–∫–∞–∑–∞–Ω—ã 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–æ—Å–µ—â–∞–ª–∏ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        </div>
        <div id="tournaments-list">
            <!-- Rendered by JS from localStorage -->
            <div class="empty-state" id="empty-state">
                <div class="empty-icon">üéæ</div>
                <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç—É—Ä–Ω–∏—Ä</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast" role="alert" aria-live="assertive">
    <div class="toast-icon">üóëÔ∏è</div>
    <div class="toast-body">
        <div class="toast-title">–¢—É—Ä–Ω–∏—Ä —É–¥–∞–ª—ë–Ω</div>
        <div class="toast-text" id="toast-text"></div>
    </div>
    <button class="toast-close" onclick="hideToast()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
</div>

<script>
(function() {
    const CACHE_KEY = 'padel_tournaments';
    const listEl   = document.getElementById('tournaments-list');
    const emptyEl  = document.getElementById('empty-state');
    const toastEl  = document.getElementById('toast');
    const toastTxt = document.getElementById('toast-text');
    let toastTimer = null;

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    window.hideToast = function() {
        toastEl.classList.remove('visible');
        clearTimeout(toastTimer);
    };

    function showToast() {
        toastTxt.textContent = `–¢—É—Ä–Ω–∏—Ä –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.`;
        toastEl.classList.add('visible');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(hideToast, 5000);
    }

    /* ‚îÄ‚îÄ Storage helpers ‚îÄ‚îÄ */
    function getCached() {
        try { return JSON.parse(localStorage.getItem(CACHE_KEY) || '{}'); } catch(e) { return {}; }
    }
    function setCached(obj) {
        try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch(e) {}
    }

    /* ‚îÄ‚îÄ Navigate with 404 check ‚îÄ‚îÄ */
    window.navigateToTournament = async function(id, itemEl) {
        itemEl.classList.add('loading');
        try {
            const res = await fetch(`/americano/tournament/${id}`, { method: 'HEAD' });
            if (res.ok) {
                window.location.href = `/americano/tournament/${id}`;
                return;
            }
            if (res.status === 404) {
                // Remove from cache
                const cached = getCached();
                delete cached[id];
                setCached(cached);

                // Animate item out
                itemEl.style.transition = 'opacity 0.3s, transform 0.3s';
                itemEl.style.opacity = '0';
                itemEl.style.transform = 'translateX(14px)';
                setTimeout(() => {
                    itemEl.remove();
                    if (!listEl.querySelector('.t-item')) emptyEl.style.display = 'block';
                }, 300);

                showToast();
                return;
            }
        } catch(e) {
            // Network error ‚Äî navigate and let server respond
        }
        window.location.href = `/americano/tournament/${id}`;
    };

    /* ‚îÄ‚îÄ Remove manually ‚îÄ‚îÄ */
    window.removeFromCache = function(id, e) {
        e.stopPropagation();
        const cached = getCached();
        delete cached[id];
        setCached(cached);
        render();
    };

    /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
    function statusLabel(status) {
        if (status === 'active')   return { text: '–ê–∫—Ç–∏–≤–µ–Ω',  cls: 'badge-active-js' };
        if (status === 'finished') return { text: '–ó–∞–≤–µ—Ä—à—ë–Ω', cls: 'badge-finished-js' };
        return { text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞', cls: 'badge-setup-js' };
    }

    function timeAgo(ts) {
        const diff = Date.now() - ts;
        const mins = Math.floor(diff / 60000);
        if (mins < 1)  return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (mins < 60) return `${mins} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24)  return `${hrs} —á. –Ω–∞–∑–∞–¥`;
        return `${Math.floor(hrs / 24)} –¥. –Ω–∞–∑–∞–¥`;
    }

    function escHtml(str) {
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
    function render() {
        const cached = getCached();
        const items  = Object.values(cached).sort((a, b) => b.visitedAt - a.visitedAt);

        listEl.querySelectorAll('.t-item').forEach(el => el.remove());


        if (items.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }

        emptyEl.style.display = 'none';

        // Remove old items (keep only those inserted by JS)
        listEl.querySelectorAll('.t-item').forEach(el => el.remove());

        items.forEach(t => {
            const sl  = statusLabel(t.status);
            const nameEsc = escHtml(t.name);
            const div = document.createElement('div');
            div.className  = 't-item';
            div.dataset.id = t.id;
            div.innerHTML  = `
                <div class="t-icon">üéæ</div>
                <div class="t-info" onclick="navigateToTournament('${t.id}', this.closest('.t-item'))">
                    <div class="t-name">${nameEsc}</div>
                    <div class="t-meta">${t.playerCount} –∏–≥—Ä–æ–∫–æ–≤ ¬∑ ${t.courts} –∫–æ—Ä—Ç(–∞) ¬∑ –†–∞—É–Ω–¥ ${t.currentRound + 1}/${t.totalRounds} ¬∑ ${timeAgo(t.visitedAt)}</div>
                </div>
                <span class="badge ${sl.cls}">${sl.text}</span>
                <button class="t-remove" title="–£–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞" onclick="removeFromCache('${t.id}', event)">‚úï</button>
            `;
            listEl.appendChild(div);
        });
    }

    render();
})();
</script>
{% endblock %}